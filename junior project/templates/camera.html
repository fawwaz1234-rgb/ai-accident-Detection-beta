{% extends "base.html" %}

{% block title %}Live Camera - AI Accident Detection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-white mb-4">
            <i class="fas fa-video"></i> Live Camera Feed
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-camera"></i> Camera Feed</h5>
                <div>
                    <button class="btn btn-success" id="startBtn" onclick="startCamera()">
                        <i class="fas fa-play"></i> Start Camera
                    </button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopCamera()" disabled>
                        <i class="fas fa-stop"></i> Stop Camera
                    </button>
                </div>
            </div>
            <div class="card-body text-center">
                <div id="cameraContainer" class="position-relative">
                    <video id="videoElement" width="100%" height="400" autoplay muted style="display: none; border-radius: 10px;"></video>
                    <canvas id="canvasElement" width="640" height="480" style="display: none; border-radius: 10px;"></canvas>
                    <div id="noCamera" class="text-center p-5">
                        <i class="fas fa-video-slash fa-5x text-muted mb-3"></i>
                        <h4 class="text-muted">Camera Not Started</h4>
                        <p class="text-muted">Click "Start Camera" to begin live detection</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>Detection Status</h6>
                                    <span id="detectionStatus" class="badge bg-secondary">Inactive</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>Confidence</h6>
                                    <span id="confidenceLevel" class="badge bg-info">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>Vehicles</h6>
                                    <span id="vehicleCount" class="badge bg-primary">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Detection Settings</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="confidenceThreshold" class="form-label">Confidence Threshold</label>
                    <input type="range" class="form-range" id="confidenceThreshold" min="0.1" max="1.0" step="0.1" value="0.7">
                    <div class="d-flex justify-content-between">
                        <small>0.1</small>
                        <small id="thresholdValue">0.7</small>
                        <small>1.0</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enableAlerts" checked>
                        <label class="form-check-label" for="enableAlerts">
                            Enable Emergency Alerts
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showBoundingBoxes" checked>
                        <label class="form-check-label" for="showBoundingBoxes">
                            Show Bounding Boxes
                        </label>
                    </div>
                </div>
                
                <hr>
                
                <h6>Detection Log</h6>
                <div id="detectionLog" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div class="text-success">System ready...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accident Alert Modal -->
<div class="modal fade" id="accidentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> ACCIDENT DETECTED!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Detection Details:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Confidence:</strong> <span id="modalConfidence"></span></li>
                            <li><strong>Vehicles Detected:</strong> <span id="modalVehicles"></span></li>
                            <li><strong>Time:</strong> <span id="modalTime"></span></li>
                            <li><strong>Location:</strong> <span id="modalLocation"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Actions Taken:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> Emergency services notified</li>
                            <li><i class="fas fa-check text-success"></i> Location coordinates sent</li>
                            <li><i class="fas fa-check text-success"></i> SMS alerts dispatched</li>
                            <li><i class="fas fa-check text-success"></i> Incident logged</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> This is a demonstration. In a real system, this would automatically contact local emergency services.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="continueMonitoring()">
                    <i class="fas fa-play"></i> Continue Monitoring
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let videoStream = null;
let isDetecting = false;
let detectionInterval = null;

// Check authentication
if (!getAuthToken()) {
    window.location.href = '/login';
}

// Update threshold display
document.getElementById('confidenceThreshold').addEventListener('input', function() {
    document.getElementById('thresholdValue').textContent = this.value;
});

function logMessage(message, type = 'info') {
    const log = document.getElementById('detectionLog');
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
    log.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
    log.scrollTop = log.scrollHeight;
}

async function startCamera() {
    try {
        logMessage('Starting camera...', 'info');
        
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const noCamera = document.getElementById('noCamera');
        
        videoStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: 'environment' // Use back camera if available
            } 
        });
        
        video.srcObject = videoStream;
        video.style.display = 'block';
        noCamera.style.display = 'none';
        
        video.onloadedmetadata = () => {
            video.play();
            logMessage('Camera started successfully', 'success');
            
            // Start detection
            startDetection();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        };
        
    } catch (error) {
        logMessage(`Camera error: ${error.message}`, 'error');
        alert('Unable to access camera. Please check permissions.');
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    
    if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
    }
    
    document.getElementById('videoElement').style.display = 'none';
    document.getElementById('noCamera').style.display = 'block';
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('detectionStatus').textContent = 'Inactive';
    document.getElementById('detectionStatus').className = 'badge bg-secondary';
    
    logMessage('Camera stopped', 'info');
}

function startDetection() {
    isDetecting = true;
    document.getElementById('detectionStatus').textContent = 'Active';
    document.getElementById('detectionStatus').className = 'badge bg-success';
    
    logMessage('Starting accident detection...', 'info');
    
    detectionInterval = setInterval(async () => {
        await detectAccident();
    }, 1000); // Check every second
}

async function detectAccident() {
    if (!isDetecting) return;
    
    try {
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');
        const thresholdInput = document.getElementById('confidenceThreshold');
        const threshold = parseFloat(thresholdInput.value || '0.7');
        
        // Ensure canvas matches video resolution for better detection
        if (video.videoWidth && video.videoHeight) {
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
        }
        // Draw current frame to canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert to base64
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // Send to detection API
        const response = await fetch('/detect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({ image: imageData, threshold })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Update UI
            const confidence = (result.confidence * 100).toFixed(1);
            document.getElementById('confidenceLevel').textContent = confidence + '%';
            document.getElementById('vehicleCount').textContent = result.vehicles_detected;
            
            // Update confidence badge color
            const confidenceBadge = document.getElementById('confidenceLevel');
            if (result.confidence > 0.8) {
                confidenceBadge.className = 'badge bg-danger';
            } else if (result.confidence > 0.6) {
                confidenceBadge.className = 'badge bg-warning';
            } else {
                confidenceBadge.className = 'badge bg-info';
            }
            
            // Check if accident detected
            if (result.accident_detected) {
                logMessage(`ACCIDENT DETECTED! Confidence: ${confidence}%`, 'error');
                showAccidentModal(result);
                stopDetection();
            } else if (result.vehicles_detected > 0) {
                logMessage(`Vehicles detected: ${result.vehicles_detected}, Confidence: ${confidence}%`, 'info');
            }
        }
    } catch (error) {
        logMessage(`Detection error: ${error.message}`, 'error');
    }
}

function stopDetection() {
    isDetecting = false;
    if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
    }
    document.getElementById('detectionStatus').textContent = 'Paused';
    document.getElementById('detectionStatus').className = 'badge bg-warning';
}

function showAccidentModal(result) {
    document.getElementById('modalConfidence').textContent = (result.confidence * 100).toFixed(1) + '%';
    document.getElementById('modalVehicles').textContent = result.vehicles_detected;
    document.getElementById('modalTime').textContent = new Date(result.timestamp).toLocaleString();
    document.getElementById('modalLocation').textContent = 'Current GPS Location';
    
    const modal = new bootstrap.Modal(document.getElementById('accidentModal'));
    modal.show();
}

function continueMonitoring() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('accidentModal'));
    modal.hide();
    startDetection();
}

// Auto-start camera on page load (optional)
// startCamera();
</script>
{% endblock %}

